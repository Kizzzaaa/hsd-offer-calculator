<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSD Offer Calculator — Templates, Valuations & PDF Scripts</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#dcefff; --card:#ffffff; --ink:#222; --muted:#333;
    --brand:#1a73e8; --brand-700:#155bb5; --soft:#f5f9ff;
    --good:#e6ffed; --bad:#ffe6e6; --ring: rgba(26,115,232,0.35);
    --border:#cbd5e1; --chip:#e6f0fa;
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#cbd5e1;
    --brand:#60a5fa; --brand-700:#3b82f6; --soft:#0b1222;
    --good:#083b15; --bad:#3b0909; --ring: rgba(96,165,250,0.45);
    --border:#1f2a37; --chip:#0b1222;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--ink);margin:0;display:flex;justify-content:center;align-items:flex-start;padding:20px}
  a{color:var(--brand)}
  .flex-container{display:flex;gap:30px;max-width:1800px;width:100%;align-items:flex-start}
  .stack{display:flex;flex-direction:column;gap:12px}
  .calculator,.sidebar{background:var(--card);padding:24px;border-radius:16px;box-shadow:0 15px 30px rgba(0,0,0,.10)}
  .calculator{width:640px;position:relative}

  /* top header with logo + title */
  .calc-header{display:flex;align-items:center;gap:14px;margin:0 0 18px 0;padding-bottom:10px;border-bottom:1px solid var(--border)}
  .calc-logo{height:40px;width:auto;display:block;object-fit:contain}
  .calc-title{font-size:28px;color:var(--brand);margin:0}

  label{display:block;margin-bottom:6px;font-weight:600;color:var(--muted)}
  input,select,textarea,button{font-family:'Poppins',sans-serif;font-size:16px}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);background:transparent;color:var(--ink);
    border-radius:10px;margin-bottom:14px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .button-group{display:flex;gap:10px;margin:10px 0;flex-wrap:wrap}
  button{padding:12px 14px;border:none;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:600;transition:.25s transform,.25s background}
  button:hover{background:var(--brand-700);transform:translateY(-1px)}
  button.secondary{background:#94a3b8;color:#0b1020}
  button.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}

  .result-card{margin-top:18px;padding:16px;border-radius:12px;background:var(--soft);font-size:18px;font-weight:600}
  .original-offer{background:var(--chip);color:var(--brand);padding:8px;border-radius:8px;margin-bottom:6px}
  .adjusted-offer{padding:8px;border-radius:8px;font-weight:700}
  .adjusted-green{background:var(--good)}
  .adjusted-red{background:var(--bad)}

  .renovation-section{margin-top:14px}
  .renovation-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .renovation-options label{display:flex;align-items:center;gap:8px;font-weight:400;cursor:pointer}
  .renovation-options input[type="checkbox"]{width:18px;height:18px;accent-color:var(--brand)}

  .sidebar{flex:1;display:flex;flex-direction:column;max-height:900px;position:sticky;top:20px;min-width:520px}
  .sidebar.wide{min-width:960px;max-width:1200px;width:100%}
  .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;position:relative}
  .sidebar-header h2{font-size:22px;color:var(--brand);margin:0}
  .sidebar-header::after{content:"";display:block;position:absolute;left:0;right:0;height:1px;background:var(--border);bottom:-8px;opacity:.6}

  .tab-buttons{display:flex;gap:8px;background:var(--chip);border-radius:12px;padding:6px;flex-wrap:wrap}
  .tab-buttons button{flex:1;border-radius:10px;margin:0;background:transparent;color:var(--ink);min-width:140px}
  .tab-buttons button.active{background:var(--brand);color:#fff}
  .tab-content{flex:1;overflow:auto;padding:12px;border:1px dashed var(--border);border-radius:12px;margin-top:10px}
  .tab-section{display:none}
  .saved-entry{padding:10px;margin-bottom:10px;background:var(--chip);border-radius:10px;font-size:14px;position:relative;cursor:pointer;word-wrap:break-word}
  .saved-entry button{position:absolute;top:6px;padding:4px 8px;font-size:12px;border-radius:6px}
  .saved-entry .del-btn{background:#ef4444;color:#fff;right:6px}
  .saved-entry .copy-btn{background:var(--brand);color:#fff;right:62px}

  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:2000;opacity:.98}
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:3000;padding:40px;justify-content:center;align-items:center;overflow:auto}
  .overlay-content{background:var(--card);color:var(--ink);border-radius:14px;max-width:1000px;width:95%;max-height:90%;margin:0 auto;padding:20px;position:relative;overflow:auto;white-space:pre-wrap}
  .close-overlay{position:absolute;top:10px;right:12px;background:#ef4444;color:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
  #themeToggle{position:fixed;top:20px;right:20px;font-size:14px;width:36px;height:36px;border-radius:50%;display:flex;justify-content:center;align-items:center;background:var(--soft);border:1px solid var(--border);cursor:pointer;transition:.25s;z-index:3500}
  #pdfOverlayFrame{width:100%;height:80vh;border:none;border-radius:10px;background:#fff}
  .pdf-actions{display:flex;gap:8px;justify-content:flex-end;margin-bottom:10px}
  .tiny-btn{padding:6px 8px;font-size:12px;border-radius:8px}

  @media (max-width:1100px){
    .flex-container{flex-direction:column;align-items:stretch}
    .calculator{width:100%}
    .sidebar{min-width:unset}
    .sidebar.wide{min-width:unset;max-width:unset;width:100%}
  }
</style>
</head>
<body>
<button id="themeToggle" aria-label="Toggle dark mode">🌙</button>

<div class="flex-container">
  <!-- Calculator -->
  <div class="calculator">
    <div class="calc-header">
      <!-- CHANGE THIS SRC TO YOUR FILE PATH -->
      <img class="calc-logo" src="./hsd-logo.png" alt="House Sales Direct"
           onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;160&quot; height=&quot;40&quot;><rect width=&quot;160&quot; height=&quot;40&quot; rx=&quot;8&quot; fill=&quot;%231a73e8&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; dominant-baseline=&quot;middle&quot; text-anchor=&quot;middle&quot; fill=&quot;white&quot; font-family=&quot;Poppins,Arial&quot; font-size=&quot;18&quot;>HSD</text></svg>';">
      <h1 class="calc-title">HSD Offer Calculator</h1>
    </div>

    <!-- Auth -->
    <div id="authBox" class="stack" style="margin:12px 0">
      <input type="email" id="authEmail" placeholder="Email" autocomplete="username">
      <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
      <div class="button-group">
        <button id="signupBtn" class="ghost" type="button">Create account</button>
        <button id="signinBtn" type="button">Sign in</button>
        <button id="logoutBtn" type="button" class="ghost">Sign out</button>
      </div>
      <small id="whoami" style="opacity:.8">Not signed in</small>
      <details style="margin-top:6px">
        <summary>Auth debug</summary>
        <pre id="authDebug" style="white-space:pre-wrap;font-size:12px;opacity:.8"></pre>
      </details>
    </div>

    <!-- Inputs -->
    <label for="customerName">Customer Name</label>
    <input type="text" id="customerName" placeholder="Enter customer name" autofocus>

    <label for="listedPrice">Listed Price (£)</label>
    <input type="text" id="listedPrice" inputmode="numeric" placeholder="e.g. 245,000">

    <label for="daysToSell">Timeframe</label>
    <select id="daysToSell">
      <option value="7">7 Days</option>
      <option value="30">30 Days</option>
      <option value="90">90 Days</option>
      <option value="180">180 Days</option>
    </select>

    <!-- Renovations FIRST -->
    <div class="renovation-section" id="renovationSection" aria-hidden="false">
      <label>Include Renovation Costs?</label>
      <div class="stack" role="radiogroup">
        <label><input type="radio" name="includeRenov" value="yes"> Yes</label>
        <label><input type="radio" name="includeRenov" value="no" checked> No</label>
      </div>

      <!-- Property Type appears only if includeRenov = yes -->
      <div id="propertyTypeGroup" style="display:none; margin-top:8px">
        <label for="propertyType">Property Type</label>
        <select id="propertyType">
          <option value="">Select property type</option>
          <option value="2 bed flat">2 Bed Flat</option>
          <option value="2 bed terrace">2 Bed Terrace</option>
          <option value="3 bed semi">3 Bed Semi</option>
          <option value="4 bed detached">4 Bed Detached</option>
          <option value="4 bed townhouse">4 Bed Townhouse</option>
          <option value="3 bed end terrace">3 Bed End Terrace</option>
          <option value="3 bed bungalow">3 Bed Bungalow</option>
        </select>
      </div>

      <div class="renovation-options" id="renovationOptions" style="display:none"></div>
    </div>

    <div class="button-group">
      <button id="calculateBtn" type="button">Calculate Offer</button>
      <button id="clearBtn" type="button" class="secondary">Clear</button>
    </div>

    <div class="result-card" id="result" aria-live="polite"></div>

    <div class="button-group">
      <button id="saveBtn" type="button">Save Calculation</button>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Saved Calculations & Templates</h2>
      <button id="exportBtn" class="tiny-btn" title="Export Backup">💾</button>
    </div>

    <div class="tab-buttons" role="tablist">
      <button class="tab-btn active" data-tab="calculations" role="tab" aria-selected="true">Saved Calculations</button>
      <button class="tab-btn" data-tab="emails" role="tab">Email Templates</button>
      <button class="tab-btn" data-tab="sms" role="tab">SMS Templates</button>
      <button class="tab-btn" data-tab="objections" role="tab">Objections</button>
      <button class="tab-btn" data-tab="scripts" role="tab">Scripts</button>
      <button class="tab-btn" data-tab="valuations" role="tab">Valuations</button>
    </div>

    <div class="tab-content">
      <div id="calculations" class="tab-section" style="display:block;">
        <div class="stack">
          <input type="text" id="searchCalc" placeholder="Search by customer name">
          <small style="opacity:.7">Tip: sign in to sync across devices</small>
          <button id="clearAllCalc" class="ghost">Clear Saved</button>
        </div>
        <div id="savedCalcList" class="stack" style="margin-top:10px"></div>
      </div>

      <!-- (Email/SMS/Objections/Scripts/Valuations tabs stay the same as your last file; they don’t affect login/saving) -->
      <div id="emails" class="tab-section"><div class="stack"><em>Use your existing content here.</em></div></div>
      <div id="sms" class="tab-section"><div class="stack"><em>Use your existing content here.</em></div></div>
      <div id="objections" class="tab-section"><div class="stack"><em>Use your existing content here.</em></div></div>
      <div id="scripts" class="tab-section"><div class="stack"><em>Use your existing content here.</em></div></div>
      <div id="valuations" class="tab-section"><div class="stack"><em>Use your existing content here.</em></div></div>
    </div>
  </div>
</div>

<!-- Overlay (for big text previews) -->
<div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
  <div class="overlay-content">
    <button class="close-overlay" id="closeOverlay" aria-label="Close overlay">Close</button>
    <div class="overlay-actions"><button id="copyOverlay" class="ghost">Copy All</button></div>
    <h3 id="overlayTitle"></h3>
    <pre id="overlayText"></pre>
  </div>
</div>

<!-- PDF Overlay (kept minimal here) -->
<div class="overlay" id="pdfOverlay" role="dialog" aria-modal="true" aria-labelledby="pdfOverlayTitle">
  <div class="overlay-content">
    <button class="close-overlay" id="closePdfOverlay" aria-label="Close PDF overlay">Close</button>
    <div class="pdf-actions">
      <button id="downloadPdfBtn" class="ghost tiny-btn">Download</button>
      <button id="openPdfNewTabBtn" class="ghost tiny-btn">Open in New Tab</button>
    </div>
    <h3 id="pdfOverlayTitle">PDF Viewer</h3>
    <iframe id="pdfOverlayFrame"></iframe>
  </div>
</div>

<!-- Supabase client + Backend -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ====== SUPABASE SETUP ======
  const SUPABASE_URL = "https://jctioxawzpslmztsstpe.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjdGlveGF3enBzbG16dHNzdHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzI4MzYsImV4cCI6MjA3NTk0ODgzNn0.USUXW5UATduMmkBDbLQ2Ll9D8a_UhTjU8knl5bJ0-Cs";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  window.supabase = supabase; // handy for console

  const Backend = {
    async session(){ const { data } = await supabase.auth.getSession(); return data.session; },
    async user(){ const { data: { user } } = await supabase.auth.getUser(); return user; },

    async signUp(email, password){
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;
      return data;
    },
    async signIn(email, password){
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      return data;
    },
    async signOut(){
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
    },

    // DB (cloud) — requires table + RLS below
    async saveCalculation(row){
      const user = await this.user();
      if (!user) throw new Error('Not signed in');
      const payload = { user_id: user.id, data: row };
      const { data, error } = await supabase.from('calculations').insert(payload).select('id').single();
      if (error) throw error;
      return data;
    },
    async listCalculations(){
      let { data, error } = await supabase
        .from('calculations')
        .select('id, data, created_at')
        .order('created_at', { ascending: false });
      if (error && /relation .*calculations.* does not exist/i.test(error.message || '')) {
        console.warn('calculations table missing — falling back to local only');
        return [];
      }
      if (error && (error.message || '').toLowerCase().includes('created_at')) {
        ({ data, error } = await supabase.from('calculations').select('id, data'));
      }
      if (error) throw error;
      return data || [];
    },
    async deleteCalculation(id){
      const { error } = await supabase.from('calculations').delete().eq('id', id);
      if (error) throw error;
    }
  };

  // ====== AUTH UI ======
  const whoami = document.getElementById('whoami');
  const authDebug = document.getElementById('authDebug');
  const email = document.getElementById('authEmail');
  const password = document.getElementById('authPassword');

  function toast(msg){
    const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 2200);
  }

  async function refreshAuthUI(){
    const user = await Backend.user();
    const session = await Backend.session();
    whoami.textContent = user ? `Signed in as ${user.email}` : 'Not signed in';
    authDebug.textContent = JSON.stringify({ user, hasSession: !!session, expires_at: session?.expires_at }, null, 2);
  }

  document.getElementById('signupBtn').onclick = async () => {
    if (!email.value || !password.value) return alert('Enter email & password');
    try {
      const data = await Backend.signUp(email.value, password.value);
      toast('Account created.');
      // If email confirmation is ON, you must confirm before first sign-in:
      if (data?.user && (data.user?.confirmed_at == null)) {
        alert('Check your inbox to confirm your email (or disable confirmation in Auth settings to test).');
      }
    } catch (e) {
      alert(e.message || 'Sign-up failed'); console.error(e);
    }
  };

  document.getElementById('signinBtn').onclick = async () => {
    if (!email.value || !password.value) return alert('Enter email & password');
    try {
      await Backend.signIn(email.value, password.value);
      toast('Signed in'); refreshAuthUI();
    } catch (e) {
      const msg = String(e?.message || '').toLowerCase();
      if (msg.includes('email not confirmed')) {
        alert('Your email is not confirmed. Confirm it in Supabase (Auth > Users) or temporarily disable confirmation in Auth settings.');
      } else {
        alert(e.message || 'Sign-in failed');
      }
      console.error(e);
    }
  };

  document.getElementById('logoutBtn').onclick = async () => {
    try { await Backend.signOut(); location.reload(); }
    catch (e) { alert(e?.message || 'Sign-out failed'); }
  };

  supabase.auth.onAuthStateChange(async () => {
    await refreshAuthUI();
    if (window.migrateLocalCalcsToCloudIfNeeded) await window.migrateLocalCalcsToCloudIfNeeded();
    if (window.syncCalcsFromCloud) await window.syncCalcsFromCloud();
  });

  refreshAuthUI();
</script>

<!-- Main App Script -->
<script>
(function(){
  // ----- Utilities -----
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const Storage = { get: (k) => JSON.parse(localStorage.getItem(k) || '[]'), set: (k, v) => localStorage.setItem(k, JSON.stringify(v)) };
  function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{t.remove();}, 2200); }
  function debounce(fn, delay){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), delay);} }
  function roundToNearestThousand(n){ return Math.round(n/1000)*1000; }
  function getSpread(p){ if(p<=149999)return 5000; if(p<=249999)return 10000; if(p<=349999)return 15000; if(p<=449999)return 20000; return 25000; }

  // ----- Elements -----
  const priceInput = $('#listedPrice');
  const customerInput = $('#customerName');
  const propertyTypeSelect = $('#propertyType');
  const daysSelect = $('#daysToSell');
  const renovationSection = $('#renovationSection');
  const renovationOptionsDiv = $('#renovationOptions');
  const propertyTypeGroup = $('#propertyTypeGroup');
  const calculateBtn = $('#calculateBtn');
  const clearBtn = $('#clearBtn');
  const saveBtn = $('#saveBtn');
  const resultDiv = $('#result');
  const themeToggle = $('#themeToggle');
  const exportBtn = $('#exportBtn');
  const sidebar = $('#sidebar');

  // Saved calcs
  const savedCalcList = $('#savedCalcList');
  const searchCalc = $('#searchCalc');
  const clearAllCalc = $('#clearAllCalc');

  // Overlay
  const overlay = $('#overlay'), overlayTitle = $('#overlayTitle'), overlayText = $('#overlayText');
  const closeOverlay = $('#closeOverlay'); const copyOverlay = $('#copyOverlay');

  // PDF overlay (kept minimal)
  const pdfOverlay = $('#pdfOverlay'); const closePdfOverlay = $('#closePdfOverlay');
  const pdfOverlayFrame = $('#pdfOverlayFrame'); const pdfOverlayTitle = $('#pdfOverlayTitle');
  const downloadPdfBtn = $('#downloadPdfBtn'); const openPdfNewTabBtn = $('#openPdfNewTabBtn');

  let currentOffers = null;
  let savedCalculations = [];

  // Renovation matrix
  const renovationCosts = {
    "2 bed flat":      { Kitchen:5000, Bathroom:1500, Redecoration:1000, Roof:null, Rewire:1500, Windows:1000, Boiler:1000, Garden:null },
    "2 bed terrace":   { Kitchen:5000, Bathroom:1500, Redecoration:850,  Roof:2500, Rewire:1500, Windows:1000, Boiler:1000, Garden:500 },
    "3 bed semi":      { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "4 bed detached":  { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "4 bed townhouse": { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "3 bed end terrace":{Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "3 bed bungalow":  { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 }
  };

  // Money formatting
  function formatMoneyInput(el){
    if(!el) return;
    el.addEventListener('input', function(){
      const v = this.value.replace(/,/g,'');
      if(v && !isNaN(v)) this.value = parseInt(v,10).toLocaleString();
      else if(v==='') this.value = '';
    });
  }
  [ priceInput ].forEach(el => formatMoneyInput(el));

  // Renovations flow
  function populateRenovations(){
    const type = propertyTypeSelect.value;
    renovationOptionsDiv.innerHTML = '';
    if (!type) return;
    const costs = renovationCosts[type];
    Object.keys(costs).forEach(item => {
      const cost = costs[item];
      const disabled = cost === null ? 'disabled' : '';
      const label = cost === null ? `${item} (N/A)` : `${item} (£${cost.toLocaleString()})`;
      const row = document.createElement('label');
      row.innerHTML = `<input type="checkbox" value="${item}" ${disabled}> ${label}`;
      renovationOptionsDiv.appendChild(row);
    });
  }

  renovationSection.addEventListener('change', (e) => {
    if (e.target.name === 'includeRenov') {
      const include = e.target.value === 'yes';
      propertyTypeGroup.style.display = include ? 'block' : 'none';
      renovationOptionsDiv.style.display = 'none';
      if (!include) { propertyTypeSelect.value = ''; renovationOptionsDiv.innerHTML = ''; }
      calculateOffer();
    }
  });
  propertyTypeSelect.addEventListener('change', () => {
    if (propertyTypeSelect.value) { populateRenovations(); renovationOptionsDiv.style.display = 'grid'; }
    else { renovationOptionsDiv.style.display = 'none'; renovationOptionsDiv.innerHTML = ''; }
    calculateOffer();
  });

  function calculateOffer(){
    const rawPrice = priceInput.value.replace(/,/g,'');
    const listedPrice = parseFloat(rawPrice);
    if(isNaN(listedPrice)){ resultDiv.textContent = 'Enter a valid listed price.'; return; }

    const days = parseInt(daysSelect.value,10);
    const spread = getSpread(listedPrice);
    let baseBottom, baseTop;
    if(days === 180){ baseTop = listedPrice * 0.95; baseBottom = baseTop - spread; }
    else if(days === 90){ baseBottom = listedPrice * 0.90; baseTop = baseBottom + spread; }
    else if(days === 30){ baseBottom = listedPrice * 0.80; baseTop = baseBottom + spread; }
    else { baseBottom = listedPrice * 0.70; baseTop = baseBottom + spread; }

    let bottomOffer = roundToNearestThousand(baseBottom);
    let topOffer = roundToNearestThousand(baseTop);
    if(bottomOffer < 0) bottomOffer = 0; if(topOffer < 0) topOffer = 0;

    const includeRenov = document.querySelector('input[name="includeRenov"]:checked')?.value === 'yes';
    let selectedRenov = []; let totalRenovation = 0;
    if (includeRenov && propertyTypeSelect.value) {
      selectedRenov = [...renovationOptionsDiv.querySelectorAll('input:checked')].map(cb => cb.value);
      selectedRenov.forEach(item => { totalRenovation += renovationCosts[propertyTypeSelect.value][item] || 0; });
    }

    const adjBottom = Math.max(0, roundToNearestThousand(bottomOffer - totalRenovation));
    const adjTop = Math.max(0, roundToNearestThousand(topOffer - totalRenovation));
    currentOffers = { bottom:bottomOffer, top:topOffer, adjBottom, adjTop, renovations:selectedRenov };

    const adjClass = adjBottom >= bottomOffer ? 'adjusted-green' : 'adjusted-red';
    resultDiv.innerHTML = `
      <div class="original-offer">Original Offer: £${bottomOffer.toLocaleString()} - £${topOffer.toLocaleString()}</div>
      ${ totalRenovation>0 ? `<div>Renovation Costs: £${totalRenovation.toLocaleString()}</div>` : '' }
      <div class="adjusted-offer ${adjClass}">Adjusted Offer: £${adjBottom.toLocaleString()} - £${adjTop.toLocaleString()}</div>
    `;
  }

  calculateBtn.addEventListener('click', calculateOffer);
  priceInput.addEventListener('keypress', e=>{ if(e.key==='Enter') calculateOffer(); });
  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear current inputs?')) return;
    customerInput.value=''; priceInput.value=''; daysSelect.value='7';
    propertyTypeSelect.value=''; propertyTypeGroup.style.display='none';
    renovationOptionsDiv.style.display='none'; renovationOptionsDiv.innerHTML='';
    resultDiv.textContent=''; currentOffers=null;
  });

  // ----- Saved Calculations (CLOUD + local fallback) -----
  function renderSavedCalc(){
    const searchTerm = (searchCalc.value || '').toLowerCase();
    savedCalcList.innerHTML = '';
    savedCalculations.forEach((entry, index)=>{
      if((entry.name||'').toLowerCase().includes(searchTerm)){
        const div = document.createElement('div'); div.className='saved-entry';
        div.innerHTML = `
          <div style="background:var(--chip);padding:6px;border-radius:8px;margin-bottom:4px;"><strong>${entry.name}</strong> | ${entry.propertyType || '—'}</div>
          <div style="background:#d0e5ff;padding:6px;border-radius:8px;">Original: £${entry.originalOffer.bottom.toLocaleString()} - £${entry.originalOffer.top.toLocaleString()}</div>
          <div style="background:${entry.adjustedOffer.bottom >= entry.originalOffer.bottom ? 'var(--good)' : 'var(--bad)'};padding:6px;border-radius:8px;margin-top:4px">Adjusted: £${entry.adjustedOffer.bottom.toLocaleString()} - £${entry.adjustedOffer.top.toLocaleString()}</div>
          <small style="opacity:.8">Saved: ${new Date(entry.timestamp).toLocaleString()}</small>
          <button class="del-btn" title="Delete">Del</button>
        `;
        div.querySelector('.del-btn').addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          if(!confirm('Delete this saved calculation?')) return;
          const row = savedCalculations[index];
          try {
            if (row.id) { await Backend.deleteCalculation(row.id); showToast('Deleted from cloud'); await window.syncCalcsFromCloud(); }
            else { savedCalculations.splice(index,1); Storage.set('hsdSaved', savedCalculations); renderSavedCalc(); showToast('Deleted locally'); }
          } catch (e) { console.error(e); showToast('Delete failed'); }
        });
        savedCalcList.appendChild(div);
      }
    });
  }

  async function syncCalcsFromCloud(){
    try {
      const user = await Backend.user();
      if (user) {
        const rows = await Backend.listCalculations();
        savedCalculations = (rows || []).map(r => ({ ...r.data, id: r.id }));
      } else {
        savedCalculations = Storage.get('hsdSaved') || [];
      }
      renderSavedCalc();
    } catch (e) {
      console.error(e); showToast('Could not sync from cloud (using local only)');
      savedCalculations = Storage.get('hsdSaved') || []; renderSavedCalc();
    }
  }
  window.syncCalcsFromCloud = syncCalcsFromCloud;

  // SAVE
  saveBtn.addEventListener('click', async ()=>{
    if(!customerInput.value.trim()) return showToast('Enter customer name first');
    if(!currentOffers) return showToast('Calculate offer first');

    const includeRenov = document.querySelector('input[name="includeRenov"]:checked')?.value === 'yes';
    const entry = {
      name: customerInput.value.trim(),
      listedPrice: priceInput.value,
      timeframe: daysSelect.value,
      includeRenov,
      propertyType: includeRenov ? (propertyTypeSelect.value || '') : '',
      renovations: currentOffers.renovations || [],
      originalOffer: { bottom: currentOffers.bottom, top: currentOffers.top },
      adjustedOffer: { bottom: currentOffers.adjBottom, top: currentOffers.adjTop },
      timestamp: new Date().toISOString()
    };

    const user = await Backend.user();
    if (user){
      try { await Backend.saveCalculation(entry); showToast('Saved to cloud'); await syncCalcsFromCloud(); return; }
      catch(e){ console.error(e); showToast('Cloud save failed — saved locally'); }
    }
    const local = Storage.get('hsdSaved') || []; local.unshift(entry); Storage.set('hsdSaved', local);
    savedCalculations = local; renderSavedCalc(); showToast('Saved locally (sign in to sync)');
  });

  searchCalc.addEventListener('input', debounce(renderSavedCalc, 160));
  clearAllCalc.addEventListener('click', ()=>{
    if(!savedCalculations.length) return showToast('Nothing to clear');
    if(!confirm('Clear ALL saved calculations?')) return;
    savedCalculations = []; Storage.set('hsdSaved', savedCalculations); renderSavedCalc(); showToast('All calculations cleared');
  });

  // initial sync
  syncCalcsFromCloud();

  // Tabs (just switch visibility)
  const tabBtns = $$('.tab-btn'), tabSections = $$('.tab-section');
  tabBtns.forEach(btn=>btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    tabSections.forEach(sec=>sec.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    if(btn.dataset.tab === 'valuations'){ sidebar.classList.add('wide'); } else { sidebar.classList.remove('wide'); }
  }));

  // Overlay helpers
  closeOverlay.addEventListener('click', ()=> overlay.style.display='none');
  copyOverlay.addEventListener('click', ()=>{ navigator.clipboard.writeText(overlayText.innerText || ''); showToast('Copied'); });

  // Export backup (local only)
  exportBtn.addEventListener('click', ()=>{
    const data = {
      hsdSaved: Storage.get('hsdSaved'),
      emails: Storage.get('emails'),
      smsTemplates: Storage.get('smsTemplates'),
      objections: Storage.get('objections'),
      scripts: Storage.get('scripts'),
      valuations: Storage.get('valuations')
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HSD_Backup.json'; a.click(); URL.revokeObjectURL(a.href);
    showToast('Backup exported');
  });

  // Theme toggle
  const THEME_KEY = 'hsd_theme';
  function setTheme(mode){ document.documentElement.setAttribute('data-theme', mode); localStorage.setItem(THEME_KEY, mode); themeToggle.textContent = mode === 'dark' ? '☀️' : '🌙'; }
  const savedTheme = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  setTheme(savedTheme);
  themeToggle.addEventListener('click', ()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));

  // Minimal PDF overlay handlers (kept)
  closePdfOverlay.addEventListener('click', ()=>{ pdfOverlayFrame.src='about:blank'; pdfOverlay.style.display='none'; });

  // One-time migration local → cloud
  window.migrateLocalCalcsToCloudIfNeeded = async function(){
    try {
      const user = await Backend.user(); if (!user) return;
      const { data: cloudSample, error } = await supabase.from('calculations').select('id').limit(1);
      if (error) { console.error(error); return; }
      const local = Storage.get('hsdSaved') || [];
      if ((!cloudSample || cloudSample.length === 0) && local.length) {
        for (const entry of local) { try { await Backend.saveCalculation(entry); } catch(e){ console.error('import failed', e); } }
        Storage.set('hsdSaved', []); showToast('Imported your local calculations to cloud');
      }
    } catch (e) { console.error(e); }
  };
})();
</script>
</body>
</html>
