<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSD Offer Calculator — Templates & Saved</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#dcefff; --card:#ffffff; --ink:#222; --muted:#333;
    --brand:#1a73e8; --brand-700:#155bb5;
    --soft:#f5f9ff; --good:#e6ffed; --bad:#ffe6e6;
    --ring: rgba(26,115,232,0.35); --border:#cbd5e1; --chip:#e6f0fa;
  }
  [data-theme="dark"]{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#cbd5e1;
    --brand:#60a5fa; --brand-700:#3b82f6;
    --soft:#0b1222; --good:#083b15; --bad:#3b0909;
    --ring: rgba(96,165,250,0.45); --border:#1f2a37; --chip:#0b1222;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif; background:var(--bg); color:var(--ink);
    margin:0; display:flex; justify-content:center; align-items:flex-start; padding:20px;
  }
  a{color:var(--brand)}
  .flex-container{display:flex; gap:30px; max-width:1800px; width:100%; align-items:flex-start}
  .stack{display:flex; flex-direction:column; gap:12px}
  .calculator,.sidebar{
    background:var(--card); padding:24px; border-radius:16px; box-shadow:0 15px 30px rgba(0,0,0,0.10);
  }
  .calculator{width:640px; position:relative}

  .calc-header{
    display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:12px;
  }
  .hsd-logo{
    height:34px; width:auto; display:block; object-fit:contain;
  }
  h2{margin:0; font-size:26px; color:var(--brand);}

  label{display:block; margin-bottom:6px; font-weight:600; color:var(--muted)}
  input,select,textarea,button{font-family:'Poppins',sans-serif; font-size:16px}
  input,select,textarea{
    width:100%; padding:12px; border:1px solid var(--border); background:transparent; color:var(--ink);
    border-radius:10px; margin-bottom:14px; outline:none;
  }
  input:focus,select:focus,textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}

  .button-group{display:flex; gap:10px; margin:10px 0; flex-wrap:wrap}
  button{
    padding:12px 14px; border:none; border-radius:10px; background:var(--brand); color:#fff; cursor:pointer;
    font-weight:600; transition:.25s transform,.25s background;
  }
  button:hover{background:var(--brand-700); transform:translateY(-1px)}
  button.secondary{background:#94a3b8; color:#0b1020}
  button.ghost{background:transparent; border:1px solid var(--border); color:var(--ink)}

  .msg{font-size:14px; line-height:1.3}
  .msg.error{color:#b91c1c}
  .msg.ok{color:#065f46}

  .result-card{margin-top:10px; padding:16px; border-radius:12px; background:var(--soft); font-size:18px; font-weight:600}
  .original-offer{background:var(--chip); color:var(--brand); padding:8px; border-radius:8px; margin-bottom:6px}
  .adjusted-offer{padding:8px; border-radius:8px; font-weight:700}
  .adjusted-green{background:var(--good)}
  .adjusted-red{background:var(--bad)}

  .renovation-section{margin-top:14px}
  .renovation-options{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
  .renovation-options label{display:flex; align-items:center; gap:8px; font-weight:400; cursor:pointer}
  .renovation-options input[type="checkbox"]{width:18px; height:18px; accent-color:var(--brand)}

  .sidebar{flex:1; display:flex; flex-direction:column; max-height:900px; position:sticky; top:20px; min-width:520px}
  .sidebar-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; position:relative}
  .sidebar-brand{display:flex; align-items:center; gap:10px}
  .sidebar-logo{height:28px; width:auto; display:block}
  .sidebar-header::after{
    content:""; display:block; position:absolute; left:0; right:0; height:1px;
    background:var(--border); bottom:-8px; opacity:.6;
  }
  .export-btn{background:transparent; border:none; cursor:pointer; font-size:16px; color:var(--brand); opacity:0.8; transition:.2s; padding:6px; border-radius:8px}
  .export-btn:hover{opacity:1; transform:scale(1.06); background:var(--soft)}

  .tab-buttons{display:flex; gap:8px; background:var(--chip); border-radius:12px; padding:6px; flex-wrap:wrap}
  .tab-buttons button{flex:1; border-radius:10px; margin:0; background:transparent; color:var(--ink); min-width:140px}
  .tab-buttons button.active{background:var(--brand); color:#fff}
  .tab-content{flex:1; overflow:auto; padding:12px; border:1px dashed var(--border); border-radius:12px; margin-top:10px}
  .tab-section{display:none}
  .saved-entry{padding:10px; margin-bottom:10px; background:var(--chip); border-radius:10px; font-size:14px; position:relative; cursor:pointer; word-wrap:break-word}
  .saved-entry button{position:absolute; top:6px; padding:4px 8px; font-size:12px; border-radius:6px}
  .saved-entry .del-btn{background:#ef4444; color:#fff; right:6px}

  .toast{
    position:fixed; bottom:18px; left:50%; transform:translateX(-50%);
    background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,.35); z-index:2000; opacity:.98
  }

  #themeToggle{
    position:fixed; top:20px; right:20px; font-size:14px; width:36px; height:36px; border-radius:50%;
    display:flex; justify-content:center; align-items:center; background:var(--soft); border:1px solid var(--border);
    cursor:pointer; transition:.25s; z-index:3500
  }
  #themeToggle:hover{background:var(--brand); color:#fff; border-color:var(--brand)}

  @media (max-width: 1100px){
    .flex-container{flex-direction:column; align-items:stretch}
    .calculator{width:100%}
    .sidebar{min-width:unset}
  }
</style>
</head>
<body>
<button id="themeToggle" aria-label="Toggle dark mode">🌙</button>

<div class="flex-container">

  <!-- Calculator -->
  <div class="calculator">
    <div class="calc-header">
      <!-- Update src to your logo path if needed -->
      <img class="hsd-logo" src="/assets/hsd-logo.png" alt="HSD Logo" />
      <h2>HSD Offer Calculator</h2>
    </div>

    <!-- Auth -->
    <div id="authBox" class="stack" style="margin:12px 0">
      <input type="email" id="authEmail" placeholder="Email" autocomplete="username">
      <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password">
      <div class="button-group">
        <button id="signupBtn" class="ghost" type="button">Create account</button>
        <button id="signinBtn" type="button">Sign in</button>
        <button id="logoutBtn" type="button" class="ghost">Sign out</button>
      </div>
      <div id="authMsg" class="msg" aria-live="polite"></div>
      <small id="whoami" style="opacity:.8">Not signed in</small>
    </div>

    <!-- Inputs -->
    <label for="customerName">Customer Name</label>
    <input type="text" id="customerName" placeholder="Enter customer name" autofocus aria-label="Customer name">

    <label for="listedPrice">Listed Price (£)</label>
    <input type="text" id="listedPrice" inputmode="numeric" placeholder="e.g. 245,000" aria-label="Listed price">

    <div class="stack">
      <div>
        <label for="daysToSell">Timeframe</label>
        <select id="daysToSell" aria-label="Timeframe to sell">
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
          <option value="90">90 Days</option>
          <option value="180">180 Days</option>
        </select>
      </div>
    </div>

    <!-- Renovations FIRST -->
    <div class="renovation-section" id="renovationSection">
      <label>Include Renovation Costs?</label>
      <div class="stack" role="radiogroup" aria-label="Include renovations">
        <label><input type="radio" name="includeRenov" value="yes"> Yes</label>
        <label><input type="radio" name="includeRenov" value="no" checked> No</label>
      </div>

      <!-- Property Type only appears if includeRenov = yes -->
      <div id="propertyTypeGroup" style="display:none; margin-top:8px">
        <label for="propertyType">Property Type</label>
        <select id="propertyType" aria-label="Property type">
          <option value="">Select property type</option>
          <option value="2 bed flat">2 Bed Flat</option>
          <option value="2 bed terrace">2 Bed Terrace</option>
          <option value="3 bed semi">3 Bed Semi</option>
          <option value="4 bed detached">4 Bed Detached</option>
          <option value="4 bed townhouse">4 Bed Townhouse</option>
          <option value="3 bed end terrace">3 Bed End Terrace</option>
          <option value="3 bed bungalow">3 Bed Bungalow</option>
        </select>
      </div>

      <div class="renovation-options" id="renovationOptions" style="display:none"></div>
    </div>

    <div class="button-group">
      <button id="calculateBtn" type="button">Calculate Offer</button>
      <button id="clearBtn" type="button" class="secondary">Clear</button>
    </div>

    <div class="result-card" id="result" aria-live="polite"></div>

    <div class="button-group">
      <button id="saveBtn" type="button">Save Calculation</button>
      <small id="saveStatus" class="msg" aria-live="polite" style="margin-left:6px"></small>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <img src="/assets/hsd-logo.png" alt="House Sales Direct" class="sidebar-logo" />
        <h2>Templates & Saved Data</h2>
      </div>
      <button id="exportBtn" class="export-btn" title="Export Backup">💾</button>
    </div>

    <div class="tab-buttons" role="tablist">
      <button class="tab-btn active" data-tab="calculations" role="tab" aria-selected="true">Saved Calculations</button>
      <button class="tab-btn" data-tab="emails" role="tab">Email Templates</button>
      <button class="tab-btn" data-tab="sms" role="tab">SMS Templates</button>
      <button class="tab-btn" data-tab="objections" role="tab">Objections</button>
    </div>

    <div class="tab-content">
      <div id="calculations" class="tab-section" style="display:block;">
        <div class="stack">
          <input type="text" id="searchCalc" placeholder="Search by customer name">
          <small style="opacity:.7">Tip: sign in to sync across devices</small>
          <button id="clearAllCalc" class="ghost">Clear Saved</button>
        </div>
        <div id="savedCalcList" class="stack" style="margin-top:10px"></div>
      </div>

      <div id="emails" class="tab-section">
        <div class="stack">
          <input type="text" id="newEmailTitle" placeholder="Template Name">
          <textarea id="newEmailContent" placeholder="Email content" rows="5"></textarea>
          <button id="saveEmail">Save Email</button>
          <input type="text" id="searchEmail" placeholder="Search Emails">
          <button id="clearAllEmails" class="ghost">Clear Emails</button>
        </div>
        <div id="emailList" class="stack" style="margin-top:10px"></div>
      </div>

      <div id="sms" class="tab-section">
        <div class="stack">
          <input type="text" id="newSMSTitle" placeholder="Template Name">
          <textarea id="newSMSContent" placeholder="SMS content" rows="3"></textarea>
          <button id="saveSMS">Save SMS</button>
          <input type="text" id="searchSMS" placeholder="Search SMS Templates">
          <button id="clearAllSMS" class="ghost">Clear SMS</button>
        </div>
        <div id="smsList" class="stack" style="margin-top:10px"></div>
      </div>

      <div id="objections" class="tab-section">
        <div class="stack">
          <input type="text" id="newObjTitle" placeholder="Objection Title">
          <textarea id="newObjContent" placeholder="Objection Script" rows="5"></textarea>
          <button id="saveObj">Save Objection</button>
          <input type="text" id="searchObj" placeholder="Search Objections">
        </div>
        <div id="objList" class="stack" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ---------- Helpers ----------
  function toast(msg){
    const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
    document.body.appendChild(t); setTimeout(()=>t.remove(),2200);
  }
  function showMsg(el, text, kind){ if(!el) return; el.textContent = text || ''; el.className = 'msg' + (kind ? ' ' + kind : ''); }
  function debounce(fn, delay){ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a), delay);} }
  function round1k(n){ return Math.round(n/1000)*1000; }

  if (location.protocol === 'file:') {
    setTimeout(()=>alert('Open this over http:// (Live Server, Vite, or npx serve). file:// breaks auth in many browsers.'), 80);
  }

  // ---------- Theme ----------
  const THEME_KEY = 'hsd_theme';
  const themeToggle = document.getElementById('themeToggle');
  function setTheme(mode){ document.documentElement.setAttribute('data-theme', mode); localStorage.setItem(THEME_KEY, mode); themeToggle.textContent = mode === 'dark' ? '☀️' : '🌙'; }
  const savedTheme = localStorage.getItem(THEME_KEY) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  setTheme(savedTheme);
  themeToggle.addEventListener('click', ()=> setTheme(document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));
</script>

<!-- App -->
<script>
  // ---------- Supabase init ----------
  const SUPABASE_URL = "https://jctioxawzpslmztsstpe.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpjdGlveGF3enBzbG16dHNzdHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzI4MzYsImV4cCI6MjA3NTk0ODgzNn0.USUXW5UATduMmkBDbLQ2Ll9D8a_UhTjU8knl5bJ0-Cs";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } }
  );

  const whoami = document.getElementById('whoami');
  const authMsg = document.getElementById('authMsg');
  const email = document.getElementById('authEmail');
  const password = document.getElementById('authPassword');

  const Backend = {
    async user(){ const { data:{ user } } = await supabase.auth.getUser(); return user; },
    async signUp(email, password){
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) throw error; return data;
    },
    async signIn(email, password){
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error; return data;
    },
    async signOut(){ const { error } = await supabase.auth.signOut(); if (error) throw error; },
    async saveCalculation(row){
      const user = await this.user(); if (!user) throw new Error('Not signed in');
      const payload = { user_id: user.id, data: row };
      const { data, error } = await supabase.from('calculations').insert(payload).select('id').single();
      if (error) throw error; return data;
    },
    async listCalculations(){
      const { data, error } = await supabase.from('calculations').select('id, data, created_at').order('created_at', { ascending:false });
      if (error) throw error; return data || [];
    },
    async deleteCalculation(id){
      const { error } = await supabase.from('calculations').delete().eq('id', id);
      if (error) throw error;
    }
  };

  async function refreshWho(){
    const u = await Backend.user();
    whoami.textContent = u ? `Signed in as ${u.email}` : 'Not signed in';
    showMsg(authMsg, '', '');
  }

  // Buttons: auth
  const signupBtn = document.getElementById('signupBtn');
  const signinBtn = document.getElementById('signinBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  signupBtn.onclick = async () => {
    if (!email.value || !password.value) return showMsg(authMsg, 'Enter email & password', 'error');
    signupBtn.disabled = signinBtn.disabled = true;
    try {
      await Backend.signUp(email.value, password.value);
      showMsg(authMsg, 'Account created. You can sign in now.', 'ok');
      toast('Account created');
    } catch (e) {
      showMsg(authMsg, e.message || 'Sign-up failed', 'error');
    } finally {
      signupBtn.disabled = signinBtn.disabled = false;
    }
  };

  signinBtn.onclick = async () => {
    if (!email.value || !password.value) return showMsg(authMsg, 'Enter email & password', 'error');
    signinBtn.disabled = signupBtn.disabled = true;
    try {
      await Backend.signIn(email.value, password.value);
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) throw new Error('Signed in, but no session returned');
      await refreshWho();
      toast('Signed in');
      if (window.syncCalcsFromCloud) window.syncCalcsFromCloud();
    } catch (e) {
      // Friendly error messages
      const msg = (e && e.message || '').toLowerCase();
      if (msg.includes('invalid login') || msg.includes('invalid email or password')) {
        showMsg(authMsg, 'Wrong email or password', 'error');
      } else {
        showMsg(authMsg, e.message || 'Sign-in failed', 'error');
      }
    } finally {
      signinBtn.disabled = signupBtn.disabled = false;
    }
  };

  logoutBtn.onclick = async () => {
    try { await Backend.signOut(); toast('Signed out'); setTimeout(()=>window.location.reload(), 250); }
    catch (e){ showMsg(authMsg, e?.message || 'Sign-out failed', 'error'); }
  };

  supabase.auth.onAuthStateChange(async () => {
    await refreshWho();
    if (window.migrateLocalCalcsToCloudIfNeeded) await window.migrateLocalCalcsToCloudIfNeeded();
    if (window.syncCalcsFromCloud) await window.syncCalcsFromCloud();
  });
  refreshWho();

  // ---------- Calculator logic ----------
  const priceInput = document.getElementById('listedPrice');
  const daysSelect = document.getElementById('daysToSell');
  const resultDiv = document.getElementById('result');
  const renovationSection = document.getElementById('renovationSection');
  const propertyTypeGroup = document.getElementById('propertyTypeGroup');
  const propertyTypeSelect = document.getElementById('propertyType');
  const renovationOptionsDiv = document.getElementById('renovationOptions');
  const customerInput = document.getElementById('customerName');
  const saveStatus = document.getElementById('saveStatus');

  const renovationCosts = {
    "2 bed flat":      { Kitchen:5000, Bathroom:1500, Redecoration:1000, Roof:null, Rewire:1500, Windows:1000, Boiler:1000, Garden:null },
    "2 bed terrace":   { Kitchen:5000, Bathroom:1500, Redecoration:850,  Roof:2500, Rewire:1500, Windows:1000, Boiler:1000, Garden:500 },
    "3 bed semi":      { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "4 bed detached":  { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "4 bed townhouse": { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "3 bed end terrace":{Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 },
    "3 bed bungalow":  { Kitchen:4000, Bathroom:3500, Redecoration:1050, Roof:2500, Rewire:2500, Windows:1000, Boiler:1000, Garden:1500 }
  };

  function formatMoneyInput(el){
    if(!el) return;
    el.addEventListener('input', function(){
      let val = this.value.replace(/,/g,'');
      if(val && !isNaN(val)){ this.value = parseInt(val,10).toLocaleString(); }
      else if(val === '') this.value = '';
    });
  }
  formatMoneyInput(priceInput);

  function getSpread(listedPrice){
    if(listedPrice <= 149999) return 5000;
    if(listedPrice <= 249999) return 10000;
    if(listedPrice <= 349999) return 15000;
    if(listedPrice <= 449999) return 20000;
    return 25000;
  }

  function populateRenovations(){
    const type = propertyTypeSelect.value;
    renovationOptionsDiv.innerHTML = '';
    if (!type) return;
    const costs = renovationCosts[type];
    Object.keys(costs).forEach(item=>{
      const cost = costs[item];
      const disabled = cost === null ? 'disabled' : '';
      const label = cost === null ? `${item} (N/A)` : `${item} (£${cost.toLocaleString()})`;
      const row = document.createElement('label');
      row.innerHTML = `<input type="checkbox" value="${item}" ${disabled}> ${label}`;
      renovationOptionsDiv.appendChild(row);
    });
  }

  renovationSection.addEventListener('change', (e) => {
    if (e.target.name === 'includeRenov') {
      const include = e.target.value === 'yes';
      propertyTypeGroup.style.display = include ? 'block' : 'none';
      renovationOptionsDiv.style.display = 'none';
      if (!include) {
        propertyTypeSelect.value = '';
        renovationOptionsDiv.innerHTML = '';
      }
      calculateOffer();
    }
  });
  propertyTypeSelect.addEventListener('change', () => {
    if (propertyTypeSelect.value) {
      populateRenovations();
      renovationOptionsDiv.style.display = 'grid';
    } else {
      renovationOptionsDiv.style.display = 'none';
      renovationOptionsDiv.innerHTML = '';
    }
    calculateOffer();
  });

  let currentOffers = null;

  function calculateOffer(){
    const raw = priceInput.value.replace(/,/g,'');
    const listed = parseFloat(raw);
    if (isNaN(listed)){ resultDiv.textContent = 'Enter a valid listed price.'; currentOffers=null; return; }

    const days = parseInt(daysSelect.value,10);
    const spread = getSpread(listed);

    let baseBottom, baseTop;
    if(days === 180){ baseTop = listed * 0.95; baseBottom = baseTop - spread; }
    else if(days === 90){ baseBottom = listed * 0.90; baseTop = baseBottom + spread; }
    else if(days === 30){ baseBottom = listed * 0.80; baseTop = baseBottom + spread; }
    else { baseBottom = listed * 0.70; baseTop = baseBottom + spread; }

    let bottomOffer = round1k(baseBottom);
    let topOffer = round1k(baseTop);
    if(bottomOffer < 0) bottomOffer = 0; if(topOffer < 0) topOffer = 0;

    // Renovations optional
    const includeRenov = document.querySelector('input[name="includeRenov"]:checked')?.value === 'yes';
    let selectedRenov = []; let totalRenov = 0;
    if (includeRenov) {
      const t = propertyTypeSelect.value;
      if (t) {
        selectedRenov = [...renovationOptionsDiv.querySelectorAll('input:checked')].map(cb => cb.value);
        selectedRenov.forEach(item => { totalRenov += renovationCosts[t][item] || 0; });
      }
    }

    const adjBottom = Math.max(0, round1k(bottomOffer - totalRenov));
    const adjTop = Math.max(0, round1k(topOffer - totalRenov));
    currentOffers = { bottom:bottomOffer, top:topOffer, adjBottom, adjTop, renovations:selectedRenov };

    const adjClass = adjBottom >= bottomOffer ? 'adjusted-green' : 'adjusted-red';
    resultDiv.innerHTML = `
      <div class="original-offer">Original Offer: £${bottomOffer.toLocaleString()} - £${topOffer.toLocaleString()}</div>
      ${ totalRenov>0 ? `<div>Renovation Costs: £${totalRenov.toLocaleString()}</div>` : '' }
      <div class="adjusted-offer ${adjClass}">Adjusted Offer: £${adjBottom.toLocaleString()} - £${adjTop.toLocaleString()}</div>
    `;
  }

  // Calculate live (no need to touch renovations)
  priceInput.addEventListener('input', debounce(calculateOffer, 120));
  daysSelect.addEventListener('change', calculateOffer);
  document.getElementById('calculateBtn').addEventListener('click', calculateOffer);
  setTimeout(calculateOffer, 0);

  // Clear
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    if(!confirm('Clear current inputs?')) return;
    customerInput.value=''; priceInput.value=''; daysSelect.value='7';
    // reset renovations UI
    document.querySelector('input[name="includeRenov"][value="no"]').checked = true;
    propertyTypeSelect.value=''; propertyTypeGroup.style.display='none';
    renovationOptionsDiv.style.display='none'; renovationOptionsDiv.innerHTML='';
    resultDiv.textContent=''; currentOffers=null; showMsg(saveStatus,'','');
  });

  // ---------- Saved Calculations (cloud + local fallback) ----------
  const Storage = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
  };
  const savedCalcList = document.getElementById('savedCalcList');
  const searchCalc = document.getElementById('searchCalc');
  const clearAllCalc = document.getElementById('clearAllCalc');

  let savedCalculations = [];

  function renderSavedCalc(){
    const q = (searchCalc.value || '').toLowerCase();
    savedCalcList.innerHTML = '';
    savedCalculations.forEach((entry, idx)=>{
      if ((entry.name||'').toLowerCase().includes(q)){
        const div = document.createElement('div'); div.className='saved-entry';
        const sourceBadge = entry.id ? 'Cloud' : 'Local';
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
            <div><strong>${entry.name}</strong> ${entry.propertyType ? ' | ' + entry.propertyType : ''}</div>
            <small style="opacity:.7; background:#fff3; padding:2px 6px; border-radius:6px; border:1px solid var(--border)">${sourceBadge}</small>
          </div>
          <div style="background:#d0e5ff; padding:6px; border-radius:8px; margin-top:6px">
            Original: £${entry.originalOffer.bottom.toLocaleString()} - £${entry.originalOffer.top.toLocaleString()}
          </div>
          <div style="background:${entry.adjustedOffer.bottom >= entry.originalOffer.bottom ? 'var(--good)' : 'var(--bad)'}; padding:6px; border-radius:8px; margin-top:6px">
            Adjusted: £${entry.adjustedOffer.bottom.toLocaleString()} - £${entry.adjustedOffer.top.toLocaleString()}
          </div>
          <small style="opacity:.8; display:block; margin-top:6px">${new Date(entry.timestamp).toLocaleString?.() || entry.timestamp}</small>
          <button class="del-btn" title="Delete">Del</button>
        `;
        div.querySelector('.del-btn').addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          if(!confirm('Delete this saved calculation?')) return;
          const row = savedCalculations[idx];
          try{
            if (row.id){ await Backend.deleteCalculation(row.id); toast('Deleted from cloud'); await syncCalcsFromCloud(); }
            else {
              savedCalculations.splice(idx,1);
              Storage.set('hsdSaved', savedCalculations);
              renderSavedCalc();
              toast('Deleted locally');
            }
          }catch(e){ console.error(e); toast('Delete failed'); }
        });
        savedCalcList.appendChild(div);
      }
    });
  }

  async function syncCalcsFromCloud(){
    try {
      const user = await Backend.user();
      if (user){
        const rows = await Backend.listCalculations();
        savedCalculations = (rows||[]).map(r => ({ ...r.data, id:r.id, created_at:r.created_at }));
      } else {
        savedCalculations = Storage.get('hsdSaved') || [];
      }
      renderSavedCalc();
    } catch (e) {
      console.error(e);
      toast('Could not sync from cloud');
      savedCalculations = Storage.get('hsdSaved') || [];
      renderSavedCalc();
    }
  }
  window.syncCalcsFromCloud = syncCalcsFromCloud;

  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    if(!customerInput.value.trim()) return toast('Enter customer name first');
    if(!currentOffers) return toast('Calculate offer first');

    const includeRenov = document.querySelector('input[name="includeRenov"]:checked')?.value === 'yes';
    const entry = {
      name: customerInput.value.trim(),
      listedPrice: priceInput.value,
      timeframe: daysSelect.value,
      includeRenov,
      propertyType: includeRenov ? (propertyTypeSelect.value || '') : '',
      renovations: currentOffers.renovations || [],
      originalOffer: { bottom: currentOffers.bottom, top: currentOffers.top },
      adjustedOffer: { bottom: currentOffers.adjBottom, top: currentOffers.adjTop },
      timestamp: new Date().toISOString()
    };

    try {
      const user = await Backend.user();
      if (user){
        try {
          await Backend.saveCalculation(entry);
          showMsg(saveStatus, 'Saved to cloud', 'ok');
          toast('Saved to cloud');
          await syncCalcsFromCloud();
        } catch (e) {
          showMsg(saveStatus, `Cloud save failed: ${e?.message || e}`, 'error');
          const local = Storage.get('hsdSaved') || [];
          local.unshift(entry); Storage.set('hsdSaved', local);
          savedCalculations = local; renderSavedCalc();
        }
      } else {
        const local = Storage.get('hsdSaved') || [];
        local.unshift(entry); Storage.set('hsdSaved', local);
        savedCalculations = local; renderSavedCalc();
        showMsg(saveStatus, 'Saved locally (sign in to sync)', 'ok');
        toast('Saved locally');
      }
    } catch (e) {
      showMsg(saveStatus, e?.message || 'Save failed', 'error');
    }
  });

  searchCalc.addEventListener('input', debounce(renderSavedCalc, 160));
  clearAllCalc.addEventListener('click', ()=>{
    if(!savedCalculations.length) return toast('Nothing to clear');
    if(!confirm('Clear ALL saved calculations?')) return;
    savedCalculations = [];
    Storage.set('hsdSaved', savedCalculations);
    renderSavedCalc();
    toast('All calculations cleared');
  });

  // Export backup (includes local saved calcs/templates)
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const data = {
      hsdSaved: Storage.get('hsdSaved'),
      emails: Storage.get('emails'),
      smsTemplates: Storage.get('smsTemplates'),
      objections: Storage.get('objections')
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'HSD_Backup.json'; a.click(); URL.revokeObjectURL(a.href);
    toast('Backup exported');
  });

  // Simple Templates/Objections local storage (unchanged)
  function setupTemplate(storageKey, titleId, contentId, listId, saveBtnId, searchId, clearId){
    let items = Storage.get(storageKey);
    const titleInput = document.getElementById(titleId);
    const contentInput = document.getElementById(contentId);
    const listDiv = document.getElementById(listId);
    const saveButton = document.getElementById(saveBtnId);
    const searchInput = document.getElementById(searchId);
    const clearButton = document.getElementById(clearId);

    function render(){
      const search = (searchInput.value || '').toLowerCase();
      listDiv.innerHTML='';
      items.forEach((e,i)=>{
        if((e.title||'').toLowerCase().includes(search)){
          const div = document.createElement('div'); div.className='saved-entry';
          div.innerHTML = `${e.title}<button class="del-btn">Del</button>`;
          div.addEventListener('click',()=>{ navigator.clipboard.writeText(e.content || ''); toast('Copied'); });
          div.querySelector('.del-btn').addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!confirm('Delete this item?')) return; items.splice(i,1); Storage.set(storageKey, items); render(); toast('Deleted'); });
          listDiv.appendChild(div);
        }
      });
    }
    saveButton.addEventListener('click', ()=>{
      if(!titleInput.value.trim() || !contentInput.value.trim()) return toast('Enter title & content');
      items.unshift({ title:titleInput.value.trim(), content:contentInput.value.trim() });
      Storage.set(storageKey, items);
      titleInput.value = ''; contentInput.value = '';
      render(); toast('Saved');
    });
    searchInput.addEventListener('input', debounce(render, 160));
    clearButton.addEventListener('click', ()=>{ if(!items.length) return toast('Nothing to clear'); if(!confirm(`Clear ALL ${storageKey} items?`)) return; items=[]; Storage.set(storageKey, items); render(); toast('Cleared'); });
    render();
  }
  setupTemplate('emails','newEmailTitle','newEmailContent','emailList','saveEmail','searchEmail','clearAllEmails');
  setupTemplate('smsTemplates','newSMSTitle','newSMSContent','smsList','saveSMS','searchSMS','clearAllSMS');

  // Objections (title+script)
  (function(){
    const listDiv = document.getElementById('objList');
    const titleInput = document.getElementById('newObjTitle');
    const contentInput = document.getElementById('newObjContent');
    const saveBtn = document.getElementById('saveObj');
    const searchInput = document.getElementById('searchObj');
    let items = Storage.get('objections');

    function render(){
      const q = (searchInput.value || '').toLowerCase();
      listDiv.innerHTML='';
      items.forEach((e,i)=>{
        if(!q || (e.title||'').toLowerCase().includes(q)){
          const div = document.createElement('div'); div.className='saved-entry';
          div.innerHTML = `${e.title}<button class="del-btn">Del</button>`;
          div.addEventListener('click',()=>{ navigator.clipboard.writeText(e.content || ''); toast('Copied'); });
          div.querySelector('.del-btn').addEventListener('click', (ev)=>{ ev.stopPropagation(); if(!confirm('Delete this item?')) return; items.splice(i,1); Storage.set('objections', items); render(); toast('Deleted'); });
          listDiv.appendChild(div);
        }
      });
    }
    saveBtn.addEventListener('click', ()=>{
      if(!titleInput.value.trim() || !contentInput.value.trim()) return toast('Enter title & content');
      items.unshift({ title:titleInput.value.trim(), content:contentInput.value.trim() });
      Storage.set('objections', items);
      titleInput.value=''; contentInput.value='';
      render(); toast('Saved');
    });
    searchInput.addEventListener('input', debounce(render, 160));
    render();
  })();

  // One-time migration: if first cloud login and local has items → import to cloud
  window.migrateLocalCalcsToCloudIfNeeded = async function(){
    try {
      const user = await Backend.user(); if (!user) return;
      const { data: sample, error } = await supabase.from('calculations').select('id').limit(1);
      if (error) { console.error(error); return; }
      const local = Storage.get('hsdSaved') || [];
      if ((!sample || sample.length === 0) && local.length){
        for (const entry of local){ try { await Backend.saveCalculation(entry); } catch(e){ console.error('import failed', e); } }
        Storage.set('hsdSaved', []);
        toast('Imported your local calculations to cloud');
      }
    } catch (e) { console.error(e); }
  };

  // Initial sync
  syncCalcsFromCloud();
</script>
</body>
</html>
